# 競馬予想システム

高度なデータ分析と機械学習を活用した競馬予想システムです。PDFからレース情報を抽出し、多角的な分析によって勝率と期待値を予測します。また、インターネット検索機能を統合して、より正確な予想を実現します。

## 主要機能

- **PDFからのデータ抽出**: レース出馬表PDFから情報を自動抽出
- **データベース管理**: 馬・騎手・レース情報の永続化と検索
- **多角的分析**: 血統、脚質、馬場適性など複数要素を考慮した評価
- **期待値計算**: オッズに基づく期待値分析と馬券推奨
- **機械学習統合**: 統計モデルとML予測の組み合わせ
- **Web検索機能**: インターネットからの最新情報取得と分析への統合
- **レース展開予想**: 各馬の脚質に基づくレース展開シミュレーション

## システム要件

- Python 3.8以上
- 必要ライブラリ: `requirements.txt` に記載

## セットアップ

1. 依存ライブラリのインストール
```bash
pip install -r requirements.txt
```

2. 環境設定
```bash
# .env.example を .env にコピーして必要に応じて編集
cp .env.example .env
```

3. ディレクトリ構造の確認
```
競馬用/
├── config/               # 設定ファイル
│   ├── predictor_config.yaml    # メイン設定
│   └── pedigree_keywords.json   # 血統キーワード
├── data/                 # データベース
├── cache/                # キャッシュデータ
│   ├── pdf/              # PDF解析キャッシュ
│   └── web/              # Web検索キャッシュ  
├── models/               # 機械学習モデル
├── logs/                 # ログファイル
└── ... (その他のPythonファイル)
```

## 使用方法

### PDFからレース予想を行う

```bash
python keiba_predictor.py --pdf <PDFファイルパス>
```

例:
```bash
python keiba_predictor.py --pdf ./data/race_card_20230521_tokyo_11.pdf
```

### レースIDで予想を行う

```bash
python keiba_predictor.py --race-id <レースID>
```

例:
```bash
python keiba_predictor.py --race-id 202305021211
```

### オプション

- `--force`: キャッシュを無視して強制的に再解析
- `--no-web`: インターネット検索を使用しない
- `--detail`: 詳細なデバッグ情報を表示
- `--config`: 別の設定ファイルを指定

## システム構成

### 主要モジュール

1. **keiba_predictor.py**
   - システム全体のエントリーポイント
   - コマンドライン引数の処理
   - 各モジュールの統合

2. **racing_system.py**
   - システムのコア機能
   - データベース管理 (RacingDatabase)
   - PDF抽出機能 (AdvancedPDFExtractor)
   - 分析エンジン (HorseRacingAnalyzer)

3. **racing_web_scraper.py**
   - インターネット検索機能
   - 馬・騎手・コース情報の取得
   - キャッシュ管理

### ワークフロー

1. PDFまたはレースIDを入力
2. レース情報の抽出/取得
3. インターネットから追加情報の取得
4. 馬ごとの詳細分析
5. 機械学習モデルによる予測
6. 最終スコアと期待値の計算
7. 出力と結果表示

## カスタマイズ

主要設定は `config/predictor_config.yaml` で編集できます：

- 評価基準の重み付け
- 機械学習モデルの設定
- Web検索パラメータ
- 表示フォーマット

## モデルについて

機械学習モデルは `models` ディレクトリに保存されます：

- `rf_classifier.joblib`: ランダムフォレスト分類器
- `gb_regressor.joblib`: 勾配ブースティング回帰器
- `scaler.joblib`: 特徴量スケーラー
- `feature_columns.json`: 使用する特徴量リスト

## Tips

- 初回実行時は必要なディレクトリが自動作成されます
- Web検索は結果をキャッシュするため、同じ情報を繰り返し取得する場合は高速です
- より良い結果を得るには、最新のレース情報PDFを使用してください
- `--detail` オプションでデバッグ出力を有効にできます

## 注意事項

- このシステムは投資判断の参考として使用するものであり、結果を保証するものではありません
- Web検索機能は外部サイトから情報を取得するため、情報の正確性は保証されません
- 利用は自己責任で行ってください

## 今後の改善予定

- GUI インターフェースの追加
- モデルの定期的な再訓練機能
- より多様なデータソースの統合
- 精度向上のためのハイパーパラメータ最適化